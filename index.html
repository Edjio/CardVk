<!DOCTYPE html>
<html>
<head>
    <title>Мои карточки персонажей</title>
    <meta charset="UTF-8">
    <style>
        .card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px;
            width: 220px;
            display: inline-block;
            vertical-align: top;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background: white;
        }

            .card img {
                width: 100%;
                height: 200px;
                object-fit: cover;
                border-radius: 5px;
                margin-bottom: 10px;
            }

            .card h3 {
                margin: 0 0 10px 0;
                color: #2a5885;
            }

            .card p {
                margin: 0;
                color: #555;
            }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            color: #f00;
            padding: 15px;
            background: #ffeeee;
            border-radius: 5px;
            margin: 15px;
        }

        .user-info {
            background: #f0f2f5;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="user-info" class="user-info">
        Загрузка информации...
    </div>
    <h1>Мои карточки персонажей</h1>
    <div id="cards-container">
        <div class="loading">Загрузка карточек...</div>
    </div>
    <div id="error" class="error" style="display: none;"></div>

    <script>
        // Функция для получения параметров из URL
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let match;

            while ((match = regex.exec(queryString))) {
                params[decodeURIComponent(match[1])] = decodeURIComponent(match[2]);
            }

            return params;
        }

        // Проверка подписи (упрощенная версия)
        function checkVkSignature(params, secretKey) {
            // В реальном приложении нужно реализовать проверку подписи
            return true;
        }

        // Основная функция загрузки данных
        async function loadData() {
            try {
                // Получаем параметры из URL
                const params = getUrlParams();
                const vkParams = {
                    userId: params['vk_user_id'],
                    language: params['vk_language'] || 'ru',
                    isAppUser: params['vk_is_app_user'] === '1',
                    areNotificationsEnabled: params['vk_are_notifications_enabled'] === '1',
                    ref: params['vk_ref'] || 'other',
                    platform: params['vk_platform'] || 'desktop_web'
                };

                // Проверяем обязательные параметры
                if (!vkParams.userId) {
                    throw new Error('Не получен VK User ID. Откройте приложение через ВКонтакте.');
                }

                // Обновляем информацию о пользователе
                document.getElementById('user-info').innerHTML = `
                        Пользователь ВКонтакте: ID ${vkParams.userId}<br>
                        Язык: ${vkParams.language} | Платформа: ${vkParams.platform}
                    `;

                // Запрашиваем карточки с сервера
                const response = await fetch(`http://localhost:8080/cards/${vkParams.userId}`);

                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status}`);
                }

                const data = await response.json();
                displayCards(data.cards);
            } catch (error) {
                console.error("Ошибка:", error);
                document.getElementById('error').textContent = `Ошибка: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            }
        }

        // Функция отображения карточек
        function displayCards(cards) {
            const container = document.getElementById('cards-container');

            if (!cards || cards.length === 0) {
                container.innerHTML = '<div class="loading">У вас пока нет карточек персонажей</div>';
                return;
            }

            container.innerHTML = '';
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.innerHTML = `
                        <h3>${card.name}</h3>
                        <img src="${card.imageUrl}"
                             alt="${card.name}"
                             onerror="this.src='https://via.placeholder.com/300x200?text=Нет+изображения'">
                        <p>${card.description}</p>
                    `;
                container.appendChild(cardElement);
            });
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadData);

        // Для отладки в мини-приложении VK
        if (window.parent !== window) {
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'vk-params') {
                    loadData();
                }
            });
        }
    </script>
</body>
</html>